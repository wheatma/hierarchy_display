/*! hierarchy_display 28-08-2014 */
!function(a){!function(b){var c=(defaults={width:1e3,height:1e3,default_value:"",data_info_format:null,max_leaf_length:10,column_width:null,leaf_click_callback:null,node_click_callback:null,async:!1,url:"",value:[],ext:null,list_html:null},document.createElement("span")),d=function(a){return c.innerHTML="",c.appendChild(document.createTextNode(a)),c.innerHTML},e=function(a,b){if(b.list_html&&"function"==typeof b.list_html)return b.list_html(a);var c=a.text,d='<i class="icon-chevron-right"></i>',e=a.is_leaf&&1==a.is_leaf?1:0;if(e){var f=b.data_info_format&&"function"==typeof b.data_info_format?b.data_info_format(a):a.data_info;d='<span class="pull-right">'+f+"</span>";var g=l(a.text,b.max_leaf_length,"...");c='<span class="leaf-text" title="'+a.text+'">'+g+"</span>"}var h='<li><a href="javascript:;" _id="'+a.id+'" _is_leaf="'+e+'"> '+d+c+"</a></li>";return h},f=function(){return'<div class="hierarchy-display"></div>'},g=function(a){var b=a.column_width?'style="width:'+a.column_width+'px;"':"";return'<ul class="nav nav-list hierarchy-display-nav" '+b+"></ul>"},h=function(a,b){var c=a.split(",");c.pop();var d=c.join(","),e=b[d]?b[d].sub_value[a].is_leaf:!1;return e?b[d].sub_value[a]:b[a]||[]},i=function(a,b){options.value[a]=b},j=function(b){var c=0;return b.find(".hierarchy-display").each(function(){c+=k(a(this))}),c},k=function(a){return a.width()+parseInt(a.css("margin-right"),10)+parseInt(a.css("margin-left"),10)+2},l=function(a,b,c){var e="",b=b||25;return a.length>b?(e=a.substring(0,b),c&&(e+=c)):e=a,d(e)};a.fn[b]=function(b){return b=a.extend(!0,defaults,b),this.each(function(){var c=this,d=a(this);return c.func={init:function(b){var e=this;return 0==b.value.length?!1:(d.css({width:b.width+"px",height:b.height+"px","overflow-x":"auto"}),$elem_container=a('<div class="hierarchy-display-container"/>').width(b.width),d.append($elem_container),e.add(b.value[0].sub_value,b),d.delegate("li","click",function(){var c=a(this),d=c.find("a"),f=c.parent().parent(),g=parseInt(d.attr("_is_leaf"),10),j=d.attr("_id"),k=h(j,b.value);return g?void(b.leaf_click_callback&&"function"==typeof b.leaf_click_callback&&b.leaf_click_callback(k)):(f.find("li.active").removeClass("active").end().nextAll("div").remove(),0==k.length?1==b.async&&""!=b.url&&a.ajax({url:b.url,type:"get",dataType:"json",data:{id:j},success:function(a){k=a.ret_msg||[],k&&(i(j,k),k.is_leaf&&1==k.is_leaf||c.addClass("active"),e.add(k.sub_value,b))},error:function(){}}):(k.is_leaf&&1==k.is_leaf||c.addClass("active"),k.sub_value&&k.sub_value!=[]&&e.add(k.sub_value,b)),void(b.node_click_callback&&"function"==typeof b.node_click_callback&&b.node_click_callback(k)))}),d.scroll(function(){var b=d.scrollTop();d.find(".hierarchy-display-affix").each(function(){var c=a(this);c.css("top",b)})}),b.ext&&"function"==typeof b.ext&&b.ext.call(c),void setTimeout(function(){b.default_value&&""!=b.default_value&&c.func.set_default(b.default_value,b)},10))},add:function(b,c){var h=f(),i=g(c),k=a(i),l=a(h);l.css("height",c.height-5).append(k);var m="";a.each(b,function(a,b){m+=e(b,c)}),k.append(m);var n=d.find(".hierarchy-display-container");n.append(l),k.height()+20>c.height&&l.width(l.width()+20);var o=j(n);o<d.width()&&(o=d.width()),n.width(o)},set_default:function(b){var c=b.split(","),e="";a.each(c,function(a,b){""==e?e=b:e+=","+b,d.find('a[_id="'+e+'"]').trigger("click")})},reset:function(){return d.html(""),this}},c.func.init(b),c.func})},a.fn[b].defaults=defaults}("hierarchy_display")}(jQuery);